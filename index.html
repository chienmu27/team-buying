<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é˜¿èƒ–åœ˜è³¼ç³»çµ±</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
  body { font-family: 'Noto Sans TC', sans-serif; background-color: #f9fafb; -webkit-tap-highlight-color: transparent; }
  .category-btn.active { background-color: #ef4444; color: white; border-color: #ef4444; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  
  /* Modal Animation */
  .modal { transition: opacity 0.25s ease; }
  body.modal-active { overflow: hidden; }
</style>
</head>
<body class="pb-20 text-gray-800">

<!-- é ‚éƒ¨å°èˆª -->
<header class="bg-red-600 text-white shadow-md sticky top-0 z-40">
  <div class="container mx-auto px-4 py-3 flex justify-between items-center">
    <h1 class="text-xl font-bold flex items-center gap-2">
      <i class="fas fa-utensils"></i> é˜¿èƒ–åœ˜è³¼
    </h1>
    <div class="flex items-center gap-3">
        <!-- åˆ‡æ›ä»‹é¢æŒ‰éˆ• -->
        <div class="bg-red-800 p-1 rounded-lg flex text-xs font-bold">
            <button onclick="switchView('client')" id="btn-view-client" class="px-3 py-1 rounded bg-white text-red-800 shadow transition">è¨‚è³¼</button>
            <button onclick="switchView('admin')" id="btn-view-admin" class="px-3 py-1 rounded text-red-200 hover:text-white transition">ç®¡ç†</button>
        </div>
    </div>
  </div>
</header>

<!-- ================= é é¢ï¼šå‰å°é»é¤ (Client View) ================= -->
<div id="view-client">
    <!-- æ­¡è¿å€å¡Š & è¨‚è³¼äººè¨­å®š -->
    <div class="bg-orange-50 border-b border-orange-100 p-4">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-3">
            <div>
                <h2 id="greeting-title" class="text-xl font-bold text-gray-800"></h2>
                <p class="text-sm text-gray-500">ä»Šå¤©æƒ³åƒé»ä»€éº¼ï¼Ÿ</p>
            </div>
            
            <div class="flex items-center gap-3 w-full md:w-auto">
                <button onclick="openNameModal()" class="flex-1 md:flex-none bg-white border border-orange-200 text-orange-700 px-4 py-2 rounded-full shadow-sm hover:bg-orange-100 transition flex items-center justify-center gap-2">
                    <i class="fas fa-user-edit"></i>
                    <span id="display-name">è¨­å®šè¨‚è³¼äºº</span>
                </button>
                
                <div onclick="toggleCart()" class="relative cursor-pointer bg-white p-2 rounded-full shadow-sm border border-gray-200 w-10 h-10 flex items-center justify-center">
                    <i class="fas fa-shopping-cart text-gray-600"></i>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡åˆ¥å°è¦½ -->
    <nav id="category-nav" class="sticky top-[60px] bg-white/95 backdrop-blur border-b overflow-x-auto whitespace-nowrap z-30 px-4 py-3 flex gap-2 no-scrollbar shadow-sm">
        <button onclick="filterMenu('all')" class="category-btn active px-4 py-1.5 rounded-full border border-gray-300 text-sm font-medium transition">å…¨éƒ¨</button>
    </nav>

    <!-- èœå–®åˆ—è¡¨ -->
    <main class="container mx-auto p-4 min-h-[50vh]">
        <div id="loading-spinner" class="text-center py-20 text-gray-400">
            <i class="fas fa-circle-notch fa-spin text-4xl mb-3 text-red-400"></i>
            <p>æ­£åœ¨è¼‰å…¥èœå–®...</p>
        </div>
        <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </main>
</div>

<!-- ================= é é¢ï¼šå¾Œå°ç®¡ç† (Admin View) ================= -->
<div id="view-admin" class="hidden container mx-auto p-4">
    <div class="flex justify-between items-center mb-6 border-b pb-4">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">è¨‚å–®ç®¡ç†</h2>
            <p id="admin-status" class="text-sm text-gray-500 mt-1">è¼‰å…¥ä¸­...</p>
        </div>
        <button onclick="loadAdminData()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-lg transition">
            <i class="fas fa-sync-alt mr-1"></i> åˆ·æ–°
        </button>
    </div>
    
    <div id="admin-orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- è¨‚å–®å¡ç‰‡å°‡ç”Ÿæˆæ–¼æ­¤ -->
    </div>
</div>

<!-- ================= å´é‚Šè³¼ç‰©è»Š ================= -->
<div id="cart-sidebar" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[60] flex flex-col">
  <div class="p-4 border-b flex justify-between items-center bg-gray-50">
    <h3 class="font-bold text-lg"><i class="fas fa-shopping-bag text-red-500 mr-2"></i>å·²é¸é¤é»</h3>
    <button onclick="toggleCart()" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition">&times;</button>
  </div>
  <div id="cart-items" class="flex-grow overflow-y-auto p-4 space-y-3"></div>
  <div class="p-4 border-t bg-gray-50 safe-area-bottom">
    <div class="flex justify-between mb-4 items-end">
        <span class="text-gray-600 text-sm">ç¸½è¨ˆ</span>
        <span class="text-red-600 font-black text-2xl" id="total-price">$0</span>
    </div>
    <button id="btn-submit" onclick="submitOrder()" class="w-full bg-red-600 hover:bg-red-700 active:scale-[0.98] text-white py-3.5 rounded-xl font-bold shadow-lg shadow-red-200 transition">
        é€å‡ºè¨‚å–®
    </button>
  </div>
</div>
<div id="overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/40 backdrop-blur-[1px] hidden z-50 transition-opacity"></div>

<!-- ================= æ¨¡æ…‹è¦–çª—ï¼šè¼¸å…¥å§“å ================= -->
<div id="modal-name" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70]">
    <div class="modal-overlay absolute w-full h-full bg-black/50 backdrop-blur-sm" onclick="closeNameModal()"></div>
    <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto transform scale-95 transition-transform duration-300">
        <div class="modal-content py-6 text-left px-6">
            <div class="flex justify-between items-center pb-3">
                <p class="text-2xl font-bold text-gray-800">ğŸ‘‹ æ‚¨å¥½ï¼</p>
                <div class="cursor-pointer z-50" onclick="closeNameModal()">
                    <i class="fas fa-times text-gray-500"></i>
                </div>
            </div>
            <p class="text-gray-500 mb-6">è«‹è¼¸å…¥æ‚¨çš„å§“åä»¥ä¾¿æˆ‘å€‘è¾¨è­˜è¨‚å–®ã€‚</p>
            <input id="input-name" type="text" class="w-full bg-gray-50 text-gray-800 text-lg border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-red-500 focus:bg-white transition" placeholder="ä¾‹å¦‚ï¼šè¨­è¨ˆéƒ¨ å°æ˜">
            <p id="name-error" class="text-red-500 text-sm mt-2 hidden"><i class="fas fa-exclamation-circle"></i> è«‹è¼¸å…¥å§“å</p>
            
            <div class="mt-6 flex justify-end">
                <button onclick="saveName()" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-700 transition">ç¢ºå®š</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= æ¨¡æ…‹è¦–çª—ï¼šå¾Œå°é©—è­‰ç¢¼ ================= -->
<div id="modal-auth" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[80]">
    <div class="modal-overlay absolute w-full h-full bg-black/60" onclick="closeAuthModal()"></div>
    <div class="modal-container bg-white w-11/12 md:max-w-sm mx-auto rounded-2xl shadow-2xl z-50 p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-2">æ¸…é™¤è¨‚å–®é©—è­‰</h3>
        <p class="text-gray-500 text-sm mb-4">è«‹è¼¸å…¥é©—è­‰ç¢¼ä»¥å®Œæˆä¸¦æ¸…é™¤ <span id="auth-target-name" class="font-bold text-red-600"></span> çš„è¨‚å–®ã€‚</p>
        <input id="input-auth-pwd" type="password" inputmode="numeric" class="w-full text-center tracking-widest text-2xl border rounded-xl px-4 py-2 mb-4 focus:ring-2 focus:ring-red-500 focus:outline-none" placeholder="â—â—â—â—">
        <div class="flex gap-3">
            <button onclick="closeAuthModal()" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
            <button onclick="confirmClearOrder()" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold shadow">ç¢ºèªæ¸…é™¤</button>
        </div>
    </div>
</div>

<script>
// ================= è¨­å®šå€ =================
// è«‹å°‡æ­¤è™•æ›¿æ›ç‚ºæ‚¨çš„ GAS ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxerKFhXEvWGwA0v_0EwtUQ58KwLZ_KIvsU7kTctg1LYzVrP2HD87xSu4p3jRa4VA69Zw/exec"; 

// ================= å…¨åŸŸè®Šæ•¸ =================
let menuData = [];
let cart = [];
let userName = "";
let currentView = "client";
let targetClearTable = ""; // æš«å­˜è¦æ¸…é™¤çš„è¨‚å–®äººå

// ================= åˆå§‹åŒ– =================
window.onload = () => {
    updateGreeting();
    // å˜—è©¦å¾ localStorage è®€å–åå­—
    const storedName = localStorage.getItem("apan_user_name");
    if(storedName) {
        userName = storedName;
        updateNameDisplay();
    }
    fetchMenu();
};

function updateGreeting() {
    const now = new Date();
    document.getElementById("greeting-title").innerText = `å—¨ï¼ä»Šå¤©æ˜¯ ${now.getMonth() + 1} æœˆ ${now.getDate()} æ—¥`;
}

// ================= API å‘¼å« =================
async function callApi(payload) {
    try {
        const res = await fetch(GAS_API_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(payload)
        });
        return await res.json();
    } catch (e) {
        console.error(e);
        return { ok: false, message: "ç¶²è·¯é€£ç·šéŒ¯èª¤" };
    }
}

// ================= è¦–åœ–åˆ‡æ› =================
function switchView(view) {
    currentView = view;
    // æ›´æ–°æŒ‰éˆ•æ¨£å¼
    const btnClient = document.getElementById('btn-view-client');
    const btnAdmin = document.getElementById('btn-view-admin');
    const viewClient = document.getElementById('view-client');
    const viewAdmin = document.getElementById('view-admin');

    if(view === 'client') {
        btnClient.className = "px-3 py-1 rounded bg-white text-red-800 shadow transition";
        btnAdmin.className = "px-3 py-1 rounded text-red-200 hover:text-white transition";
        viewClient.classList.remove('hidden');
        viewAdmin.classList.add('hidden');
    } else {
        btnClient.className = "px-3 py-1 rounded text-red-200 hover:text-white transition";
        btnAdmin.className = "px-3 py-1 rounded bg-white text-red-800 shadow transition";
        viewClient.classList.add('hidden');
        viewAdmin.classList.remove('hidden');
        loadAdminData(); // åˆ‡æ›åˆ°å¾Œå°æ™‚è‡ªå‹•è®€å–
    }
}

// ================= å‰å°é‚è¼¯ =================

// 1. è¨‚è³¼äººå§“åè¨­å®š
function openNameModal() {
    const modal = document.getElementById('modal-name');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    modal.querySelector('.modal-container').classList.remove('scale-95');
    modal.querySelector('.modal-container').classList.add('scale-100');
    document.getElementById('input-name').value = userName;
    document.getElementById('input-name').focus();
}

function closeNameModal() {
    const modal = document.getElementById('modal-name');
    modal.classList.add('opacity-0', 'pointer-events-none');
    modal.querySelector('.modal-container').classList.add('scale-95');
    modal.querySelector('.modal-container').classList.remove('scale-100');
    document.getElementById('name-error').classList.add('hidden');
}

function saveName() {
    const input = document.getElementById('input-name').value.trim();
    if(!input) {
        document.getElementById('name-error').classList.remove('hidden');
        return;
    }
    userName = input;
    localStorage.setItem("apan_user_name", userName);
    updateNameDisplay();
    closeNameModal();
}

function updateNameDisplay() {
    const el = document.getElementById('display-name');
    if(userName) {
        el.innerText = userName;
        el.classList.add('font-bold');
    } else {
        el.innerText = "è¨­å®šè¨‚è³¼äºº";
        el.classList.remove('font-bold');
    }
}

// 2. èœå–®èˆ‡è³¼ç‰©è»Š
async function fetchMenu() {
    try {
        const res = await fetch(`${GAS_API_URL}?action=getMenu`);
        const result = await res.json();
        if (result.ok) {
            menuData = result.data;
            renderCategories();
            displayMenu('all');
            document.getElementById('loading-spinner').style.display = 'none';
        } else {
            throw new Error(result.message);
        }
    } catch (e) {
        document.getElementById('loading-spinner').innerHTML = `<p class="text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†<br><span class="text-xs text-gray-400">${e.message}</span></p>`;
    }
}

function renderCategories() {
    const nav = document.getElementById('category-nav');
    // ä¿ç•™ "å…¨éƒ¨" æŒ‰éˆ•ï¼Œç§»é™¤å…¶ä»–
    nav.innerHTML = '<button onclick="filterMenu(\'all\')" class="category-btn active px-4 py-1.5 rounded-full border border-gray-300 text-sm font-medium transition">å…¨éƒ¨</button>';
    
    const cats = [...new Set(menuData.map(i => i.category))];
    cats.forEach(c => {
        const b = document.createElement('button');
        b.className = "category-btn px-4 py-1.5 rounded-full border border-gray-300 text-sm text-gray-600 transition";
        b.innerText = c;
        b.onclick = () => filterMenu(c);
        nav.appendChild(b);
    });
}

function filterMenu(c) {
    document.querySelectorAll('.category-btn').forEach(b => {
        const isActive = b.innerText === c || (c==='all' && b.innerText==='å…¨éƒ¨');
        b.classList.toggle('active', isActive);
        b.classList.toggle('text-gray-600', !isActive);
        b.classList.toggle('border-gray-300', !isActive);
    });
    displayMenu(c);
}

function displayMenu(category) {
    const container = document.getElementById('menu-container');
    container.innerHTML = '';
    const items = category === 'all' ? menuData : menuData.filter(i => i.category === category);
    
    if(items.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-10">æ­¤åˆ†é¡æš«ç„¡å•†å“</div>';
        return;
    }

    items.forEach(i => {
        const el = document.createElement('div');
        el.className = "bg-white rounded-2xl shadow-sm border border-gray-100 p-4 flex flex-col justify-between h-full hover:shadow-md transition";
        el.innerHTML = `
            <div class="mb-3">
                <div class="flex justify-between items-start mb-1">
                    <span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded-md font-bold">${i.category}</span>
                </div>
                <h3 class="font-bold text-lg text-gray-800 leading-tight">${i.name}</h3>
                <p class="text-xs text-gray-400 mt-1 line-clamp-2">${i.desc}</p>
            </div>
            <div class="flex justify-between items-end mt-2">
                <p class="text-red-600 font-black text-lg">$${i.price}</p>
                <button onclick="addToCart(${i.id})" class="bg-red-50 hover:bg-red-100 active:bg-red-200 text-red-600 w-9 h-9 rounded-full flex items-center justify-center transition shadow-sm">
                    <i class="fas fa-plus"></i>
                </button>
            </div>`;
        container.appendChild(el);
    });
}

function addToCart(id) {
    const item = menuData.find(m => m.id === id);
    const existing = cart.find(c => c.id === id);
    if (existing) {
        existing.qty++;
    } else {
        cart.push({...item, qty: 1});
    }
    
    // å°å‹•ç•«æç¤º
    const cartIcon = document.getElementById('cart-count');
    cartIcon.classList.add('scale-125');
    setTimeout(()=>cartIcon.classList.remove('scale-125'), 200);
    
    updateCartUI();
}

function updateCartUI() {
    const list = document.getElementById('cart-items');
    list.innerHTML = '';
    
    if (cart.length === 0) {
        list.innerHTML = `
            <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                <i class="fas fa-shopping-basket text-4xl mb-2 text-gray-200"></i>
                <p>é‚„æ²’é¸æ“‡é¤é»å–”</p>
            </div>`;
        document.getElementById('cart-count').innerText = "0";
        document.getElementById('total-price').innerText = "$0";
        return;
    }

    let total = 0;
    let count = 0;
    
    cart.forEach((c, index) => {
        total += c.price * c.qty;
        count += c.qty;
        
        const row = document.createElement('div');
        row.className = "flex justify-between items-center bg-gray-50 p-3 rounded-xl";
        row.innerHTML = `
            <div class="flex-1">
                <div class="font-bold text-gray-800">${c.name}</div>
                <div class="text-xs text-gray-500">$${c.price} / ä»½</div>
            </div>
            <div class="flex items-center gap-3 bg-white px-2 py-1 rounded-lg border border-gray-200 shadow-sm">
                <button onclick="changeQty(${index}, -1)" class="text-gray-400 hover:text-red-600 w-5 text-center"><i class="fas fa-minus text-xs"></i></button>
                <span class="font-bold w-4 text-center text-sm">${c.qty}</span>
                <button onclick="changeQty(${index}, 1)" class="text-gray-400 hover:text-green-600 w-5 text-center"><i class="fas fa-plus text-xs"></i></button>
            </div>
            <div class="w-14 text-right font-bold text-gray-700">$${c.price * c.qty}</div>
        `;
        list.appendChild(row);
    });
    
    document.getElementById('cart-count').innerText = count;
    document.getElementById('total-price').innerText = `$${total}`;
}

function changeQty(index, delta) {
    cart[index].qty += delta;
    if(cart[index].qty <= 0) cart.splice(index, 1);
    updateCartUI();
}

function toggleCart() {
    document.getElementById('cart-sidebar').classList.toggle('translate-x-full');
    document.getElementById('overlay').classList.toggle('hidden');
    document.body.classList.toggle('modal-active');
}

async function submitOrder() {
    if(!userName) {
        alert("è«‹å…ˆè¨­å®šè¨‚è³¼äººå§“åï¼");
        toggleCart();
        openNameModal();
        return;
    }
    if(!cart.length) return alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");

    const btn = document.getElementById('btn-submit');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> å‚³é€ä¸­...';

    const res = await callApi({ action: "submitOrder", name: userName, items: cart });
    
    if(res.ok) {
        alert("âœ… è¨‚å–®å·²é€å‡ºï¼");
        cart = [];
        updateCartUI();
        toggleCart();
    } else {
        alert("âŒ å‚³é€å¤±æ•—ï¼š" + (res.message || "æœªçŸ¥éŒ¯èª¤"));
    }
    
    btn.disabled = false;
    btn.innerHTML = originalText;
}


// ================= å¾Œå°é‚è¼¯ (Admin) =================

async function loadAdminData() {
    const statusEl = document.getElementById('admin-status');
    const container = document.getElementById('admin-orders-container');
    statusEl.innerText = "è³‡æ–™è®€å–ä¸­...";
    container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';

    const res = await callApi({ action: "getPendingOrdersMerged" });
    
    if(res.ok) {
        const list = res.data || [];
        statusEl.innerText = list.length === 0 ? "ç›®å‰æ²’æœ‰æœªçµè¨‚å–®" : `ç›®å‰æœ‰ ${list.length} ç­†è¨‚å–®`;
        renderAdminTables(list);
    } else {
        statusEl.innerText = "è®€å–å¤±æ•—";
        container.innerHTML = `<div class="col-span-full text-center text-red-500">${res.message}</div>`;
    }
}

function renderAdminTables(data) {
    const container = document.getElementById('admin-orders-container');
    container.innerHTML = "";
    
    if(data.length === 0) {
        container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-300">
            <i class="fas fa-clipboard-check text-6xl mb-4"></i>
            <p class="text-lg">å¤ªæ£’äº†ï¼æ‰€æœ‰è¨‚å–®éƒ½è™•ç†å®Œäº†</p>
        </div>`;
        return;
    }

    data.forEach(t => {
        // status: pending (æ–°è¨‚å–®) -> served (å·²é ˜å–/ä¸Šèœ) -> completed (å·²çµå–®/æ¸…é™¤)
        // ä»‹é¢æŒ‰éˆ•é‚è¼¯ï¼š
        // å¦‚æœæ˜¯ pending -> é¡¯ç¤ºã€Œé ˜å–ã€æŒ‰éˆ• (è®Šç‚º served) -> ä¸éœ€å¯†ç¢¼
        // å¦‚æœæ˜¯ served -> é¡¯ç¤ºã€Œæ¸…é™¤ã€æŒ‰éˆ• (è®Šç‚º completed) -> éœ€å¯†ç¢¼
        
        const isServed = t.status === 'served';
        const cardClass = isServed ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200';
        
        let itemsHtml = t.items.map(x => `
            <div class="flex justify-between border-b border-gray-100 last:border-0 py-2 text-sm">
                <div class="text-gray-700">
                    <span class="font-bold text-gray-900">${x.item}</span> 
                    <span class="text-xs text-gray-500 ml-1">x${x.qty}</span>
                </div>
                <div class="font-bold text-gray-600">$${x.subtotal}</div>
            </div>`
        ).join("");

        const div = document.createElement('div');
        div.className = `rounded-2xl shadow-sm border p-5 transition-all ${cardClass}`;
        
        // æŒ‰éˆ•é‚è¼¯
        // 1. å°šæœªé ˜å– -> æŒ‰ä¸‹è®Šæ›´ç‚ºå·²é ˜å– (ä¸éœ€è¦å¯†ç¢¼)
        // 2. å·²é ˜å– -> æŒ‰ä¸‹æ¸…é™¤ (éœ€è¦å¯†ç¢¼)
        const btnHtml = isServed 
            ? `<button onclick="triggerClearAuth('${t.name}')" class="bg-gray-800 hover:bg-gray-900 text-white text-sm font-bold px-4 py-2 rounded-lg shadow transition"><i class="fas fa-check-double mr-1"></i> æ¸…é™¤</button>`
            : `<button onclick="markAsServed('${t.name}')" class="bg-green-500 hover:bg-green-600 text-white text-sm font-bold px-4 py-2 rounded-lg shadow transition"><i class="fas fa-bell mr-1"></i> é ˜å–</button>`;
        
        const statusBadge = isServed
            ? `<span class="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded font-bold">å·²å–é¤</span>`
            : `<span class="bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded font-bold">æº–å‚™ä¸­</span>`;

        div.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div>
                    <div class="flex items-center gap-2">
                        <h3 class="text-xl font-black text-gray-800">${t.name}</h3>
                        ${statusBadge}
                    </div>
                    <div class="text-xs text-gray-400 mt-1"><i class="far fa-clock"></i> ${formatTime(t.time)}</div>
                </div>
                ${btnHtml}
            </div>
            <div class="bg-white/50 rounded-xl p-2 mb-3 space-y-1">
                ${itemsHtml}
            </div>
            <div class="flex justify-between items-center pt-2 border-t border-gray-200/50">
                <span class="font-bold text-gray-500 text-sm">ç¸½é‡‘é¡</span>
                <span class="font-black text-xl text-red-600">$${t.total}</span>
            </div>
        `;
        container.appendChild(div);
    });
}

// æ ¼å¼åŒ–æ™‚é–“ HH:mm
function formatTime(isoStr) {
    try {
        const d = new Date(isoStr);
        return d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
    } catch(e) { return "--:--"; }
}

// å‹•ä½œï¼šæ¨™è¨˜ç‚ºå·²é ˜å– (ä¸éœ€å¯†ç¢¼)
async function markAsServed(name) {
    const res = await callApi({ action: "markTableStatus", table: name, status: "served" });
    if(res.ok) {
        loadAdminData(); // é‡æ–°è®€å–
    } else {
        alert("æ›´æ–°å¤±æ•—");
    }
}

// å‹•ä½œï¼šè§¸ç™¼æ¸…é™¤é©—è­‰
function triggerClearAuth(name) {
    targetClearTable = name;
    document.getElementById('auth-target-name').innerText = name;
    document.getElementById('input-auth-pwd').value = "";
    
    const modal = document.getElementById('modal-auth');
    modal.classList.remove('opacity-0', 'pointer-events-none');
    document.getElementById('input-auth-pwd').focus();
}

function closeAuthModal() {
    document.getElementById('modal-auth').classList.add('opacity-0', 'pointer-events-none');
    targetClearTable = "";
}

// å‹•ä½œï¼šé€å‡ºæ¸…é™¤è«‹æ±‚ (éœ€å¯†ç¢¼)
async function confirmClearOrder() {
    const pwd = document.getElementById('input-auth-pwd').value;
    if(!pwd) return alert("è«‹è¼¸å…¥é©—è­‰ç¢¼");
    
    const btn = document.querySelector('#modal-auth button.bg-red-600');
    const orgText = btn.innerText;
    btn.innerText = "è™•ç†ä¸­...";
    btn.disabled = true;

    const res = await callApi({ 
        action: "markTableStatus", 
        table: targetClearTable, 
        status: "completed",
        password: pwd 
    });

    btn.innerText = orgText;
    btn.disabled = false;

    if(res.ok) {
        closeAuthModal();
        loadAdminData();
    } else {
        alert(res.message || "é©—è­‰ç¢¼éŒ¯èª¤æˆ–ç³»çµ±ç•°å¸¸");
        document.getElementById('input-auth-pwd').value = "";
        document.getElementById('input-auth-pwd').focus();
    }
}

// éµç›¤æ”¯æ´ï¼šåœ¨é©—è­‰ç¢¼è¼¸å…¥æ¡†æŒ‰ Enter é€å‡º
document.getElementById('input-auth-pwd').addEventListener('keyup', (e) => {
    if(e.key === 'Enter') confirmClearOrder();
});
</script>
</body>
</html>
